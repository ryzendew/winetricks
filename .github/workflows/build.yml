name: Build

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    name: Build Linux binaries
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libssl-dev pkg-config ccache
          
      - name: Setup ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      - name: Configure ccache
        run: |
          ccache --set-config=compression=true
          ccache --set-config=max_size=500M
          ccache -s
        env:
          CCACHE_DIR: ~/.ccache

      - name: Build CLI (Release)
        run: |
          export CC="ccache gcc"
          export CXX="ccache g++"
          cargo build --release --bin winetricks
        env:
          CCACHE_DIR: ~/.ccache

      - name: Build GUI (Release)
        run: |
          export CC="ccache gcc"
          export CXX="ccache g++"
          cargo build --release --bin winetricks-gui
        env:
          CCACHE_DIR: ~/.ccache

      - name: Build Converter (Release)
        run: |
          export CC="ccache gcc"
          export CXX="ccache g++"
          cargo build --release --bin winetricks-converter
        env:
          CCACHE_DIR: ~/.ccache
          
      - name: Show ccache statistics
        run: ccache -s
        env:
          CCACHE_DIR: ~/.ccache

      - name: Upload CLI artifacts
        uses: actions/upload-artifact@v4
        with:
          name: winetricks-binaries
          path: target/release/winetricks*
          if-no-files-found: warn
          
      - name: Run tests
        run: cargo test --release

  build-deb:
    name: Build Debian Package
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libssl-dev \
            pkg-config \
            dh-make \
            debhelper \
            devscripts \
            fakeroot \
            ccache
            
      - name: Setup ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      - name: Configure ccache
        run: |
          ccache --set-config=compression=true
          ccache --set-config=max_size=500M
          ccache -s
        env:
          CCACHE_DIR: ~/.ccache

      - name: Install cargo-deb
        run: cargo install cargo-deb

      - name: Build binaries
        run: |
          export CC="ccache gcc"
          export CXX="ccache g++"
          cargo build --release --bin winetricks
          cargo build --release --bin winetricks-gui
        env:
          CCACHE_DIR: ~/.ccache
          
      - name: Show ccache statistics
        run: ccache -s
        env:
          CCACHE_DIR: ~/.ccache

      - name: Create Debian package
        run: |
          cargo deb --manifest-path winetricks-cli/Cargo.toml --no-build
          
      - name: Upload Debian package
        uses: actions/upload-artifact@v4
        with:
          name: deb-package
          path: target/debian/*.deb
          if-no-files-found: warn

  build-rpm:
    name: Build RPM Package
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libssl-dev \
            pkg-config \
            rpm \
            ccache
          # rpm-build command is provided by rpm package on Ubuntu
          # Verify rpmbuild is available
          which rpmbuild || (echo "rpmbuild not found, rpm package may be incomplete" && exit 1)
          
      - name: Setup ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      - name: Configure ccache
        run: |
          ccache --set-config=compression=true
          ccache --set-config=max_size=500M
          ccache -s
        env:
          CCACHE_DIR: ~/.ccache

      - name: Build binaries
        run: |
          export CC="ccache gcc"
          export CXX="ccache g++"
          cargo build --release --bin winetricks
          cargo build --release --bin winetricks-gui
        env:
          CCACHE_DIR: ~/.ccache
          
      - name: Show ccache statistics
        run: ccache -s
        env:
          CCACHE_DIR: ~/.ccache

      - name: Create RPM package
        run: |
          bash .github/scripts/build-rpm.sh
          
      - name: Upload RPM package
        uses: actions/upload-artifact@v4
        with:
          name: rpm-package
          path: target/release/rpmbuild/RPMS/**/*.rpm
          if-no-files-found: warn

  build-arch:
    name: Build Arch Package
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libssl-dev \
            pkg-config \
            ccache
          # Install Docker (avoid conflicts with existing containerd)
          sudo apt-get install -y docker.io || \
            (sudo apt-get remove -y containerd.io 2>/dev/null || true; \
             sudo apt-get install -y docker.io)
          sudo systemctl start docker || true
          # Verify Docker works
          sudo docker ps || echo "Docker verification skipped"
          
      - name: Setup ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      - name: Configure ccache
        run: |
          ccache --set-config=compression=true
          ccache --set-config=max_size=500M
          ccache -s
        env:
          CCACHE_DIR: ~/.ccache

      - name: Build binaries
        run: |
          export CC="ccache gcc"
          export CXX="ccache g++"
          cargo build --release --bin winetricks
          cargo build --release --bin winetricks-gui
        env:
          CCACHE_DIR: ~/.ccache
          
      - name: Show ccache statistics
        run: ccache -s
        env:
          CCACHE_DIR: ~/.ccache

      - name: Update PKGBUILD version
        run: |
          # Get version from workspace Cargo.toml (where version is actually defined)
          VERSION=$(grep -m1 '^version\s*=' Cargo.toml | cut -d'"' -f2 | tr -d '[:space:]' || echo "0.1.0")
          sed -i "s/^pkgver=.*/pkgver=${VERSION}/" PKGBUILD
          echo "Updated PKGBUILD pkgver to: ${VERSION}"
          grep "^pkgver=" PKGBUILD

      - name: Create Arch package
        run: |
          bash .github/scripts/build-arch.sh
          
      - name: Upload Arch package
        uses: actions/upload-artifact@v4
        with:
          name: arch-package
          path: winetricks-*.pkg.tar.zst
          if-no-files-found: warn
